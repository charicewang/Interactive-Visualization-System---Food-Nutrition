<!-- 
這是正式版！ 
未修正的BUG：
1. 微觀資料點的『全部營養』顯示不正確，應該是要另外兩種加起來的樣子
2. 所有東西都要變成英文
3. 加入餐盤後不可互動就會變灰色，感覺怪怪的 -->

<!-- 
改動部分:
1. 微觀資料點營養素位置調整、畫布大小調整、修正『全部營養』顯示，改成另外兩種加起來的樣子
2. 甜甜圈圖裡的食物圓點排列改成小圓在內圈
3. data欄位更改，把一些奇怪的分類(例如"豆類類"那些)歸到正確的分類，變成總共就只有七大類
4. 餐盤旁的小圓最大半徑調成35
5. 清除餐盤裡的食物圓點後，圓點會回到原位而非直接消失 -->

<!-- 
一些問題:
1. 有些標籤有點奇怪，像是把甜點分到水果去(要努力掩蓋的部分)
2. 微觀資料點營養素那裏有點雜(但好像也還可以接受)，考慮要不要再加些明顯的視覺上的分別
3. 營養素要完全達標好像很困難，看要不要只考慮基本五大營養(可能分兩個區塊，上面是五大營養，其餘營養素下面區塊，
   這樣全部都可以保留，但主要就是看五大營養那裡)
4. 最後就是有的分群太小圓點會超出範圍 -->

<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能營養分析餐盤系統 - 完整版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

        .main-content {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .chart-section {
            flex: 1;
            min-width: 700px;
        }

        .plate-section {
            flex: 0 0 450px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* 排序控制面板樣式 */
        .sorting-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sorting-controls label {
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            font-size: 14px;
        }

        #sort-selector {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            transition: border-color 0.3s;
        }

        #sort-selector:focus {
            outline: none;
            border-color: #667eea;
        }

        .sort-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            white-space: nowrap;
        }

        .sort-btn:hover {
            transform: translateY(-1px);
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 11px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            line-height: 1.4;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .center-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }

        .center-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .center-subtitle {
            font-size: 14px;
            color: #666;
        }

        .loading {
            text-align: center;
            font-size: 18px;
            color: #666;
            padding: 50px;
        }

        /* 餐盤相關樣式 */
        .plate-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .meal-selector {
            margin-bottom: 20px;
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
        }

        .meal-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .plate-container {
            position: relative;
            width: 350px;
            height: 350px;
            margin: 0 auto 20px;
        }

        .plate {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: #444;
            border: 3px solid #fff;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: hidden;
        }

        .plate-food-item {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid white;
            cursor: pointer;
        }

        .nutrient-circle.started {
            background: #ffc107;
            /* 黃色：開始加入 */
        }

        .nutrient-circle {
            position: absolute;
            border-radius: 50%;
            background: #888;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: black;
            font-weight: bold;
            text-align: center;
            line-height: 1.1;
        }

        .nutrient-circle.complete {
            background: green;
        }

        .nutrient-circle.over-limit {
            background: red;
            animation: shake 0.5s infinite;
        }

        .nutrient-circle.insufficient {
            background: orange;
        }

        @keyframes shake {
            0% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(-2px, 1px);
            }

            50% {
                transform: translate(2px, -1px);
            }

            75% {
                transform: translate(-1px, 2px);
            }

            100% {
                transform: translate(1px, -2px);
            }
        }

        .tdee-form {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tdee-form label {
            display: block;
            margin-top: 8px;
            font-size: 12px;
            color: #333;
        }

        .tdee-form input,
        .tdee-form select {
            width: 100%;
            margin-top: 4px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .tdee-form button {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .tdee-display {
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
        }

        .recommend-display {
            margin-top: 10px;
            font-size: 12px;
        }

        .recommend-display div {
            margin-bottom: 4px;
        }

        .draggable {
            cursor: grab;
        }

        .draggable:active {
            cursor: grabbing;
        }

        /* .disabled {
            opacity: 0.3;
            pointer-events: none;
        } */

        .disabled {
            opacity: 0.3 !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        .meal-ratios {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .meal-ratios h4 {
            margin: 0 0 8px 0;
            color: #333;
        }

        .ratio-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .nutrient-status {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }

        .nutrient-status h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }

        .nutrient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .nutrient-value {
            font-weight: bold;
        }

        .nutrient-value.complete {
            color: green;
        }

        .nutrient-value.over-limit {
            color: red;
        }

        .nutrient-value.insufficient {
            color: orange;
        }

        /* 比較面板樣式 */
        .comparison-panel {
            width: 100%;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px dashed #ddd;
            transition: border-color 0.3s;
            margin-top: 20px;
        }

        .comparison-panel.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .comparison-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .clear-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .clear-btn:hover {
            background: #ff5252;
        }

        .comparison-hint {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px dashed #ccc;
        }

        .comparison-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
            overflow-y: auto;
            max-height: 400px;
            padding-right: 10px;
        }

        .comparison-items::-webkit-scrollbar {
            width: 8px;
        }

        .comparison-items::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .comparison-items::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .comparison-items::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .comparison-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.2s;
            width: 100%;
        }

        .comparison-item:hover {
            transform: translateY(-2px);
        }

        .comparison-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .comparison-item-title {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            flex: 1;
            margin-right: 10px;
        }

        .comparison-item-remove {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .comparison-item-remove:hover {
            background: #ff5252;
        }

        .comparison-item-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .nutrition-chart {
            position: relative;
            height: 320px;
        }

        .nutrition-chart svg {
            width: 100%;
            height: 100%;
        }

        .nutrition-mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nutrition-mode-selector label {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }

        .mode-btn {
            background: #f8f9fa;
            border: 2px solid #ddd;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .mode-btn:hover {
            transform: translateY(-1px);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="title">智能營養分析餐盤系統 - 完整版</div>
        <div class="subtitle">拖拽食物到餐盤中，智能分析營養攝取與建議比例</div>

        <div id="loading" class="loading">載入資料中...</div>

        <div id="chart-wrapper" style="display: none;">
            <div class="main-content">
                <div class="chart-section">
                    <!-- 排序控制面板 -->
                    <div class="sorting-controls">
                        <label for="sort-selector">排序依據：</label>
                        <select id="sort-selector">
                            <optgroup label="巨量營養素">
                                <option value="energy" selected>熱量 (Energy_kcal)</option>
                                <option value="protein">蛋白質 (Protein_g)</option>
                                <option value="fat">脂肪 (Fat_g)</option>
                                <option value="carb">碳水化合物 (Carb_g)</option>
                                <option value="sugar">糖分 (Sugar_g)</option>
                                <option value="fiber">纖維 (Fiber_g)</option>
                            </optgroup>
                            <optgroup label="維生素">
                                <option value="vitA">維生素A (VitA_mcg)</option>
                                <option value="vitB6">維生素B6 (VitB6_mg)</option>
                                <option value="vitB12">維生素B12 (VitB12_mcg)</option>
                                <option value="vitC">維生素C (VitC_mg)</option>
                                <option value="vitE">維生素E (VitE_mg)</option>
                                <option value="folate">葉酸 (Folate_mcg)</option>
                                <option value="niacin">菸鹼酸 (Niacin_mg)</option>
                                <option value="riboflavin">核黃素 (Riboflavin_mg)</option>
                                <option value="thiamin">硫胺素 (Thiamin_mg)</option>
                            </optgroup>
                            <optgroup label="礦物質">
                                <option value="calcium">鈣 (Calcium_mg)</option>
                                <option value="copper">銅 (Copper_mcg)</option>
                                <option value="iron">鐵 (Iron_mg)</option>
                                <option value="magnesium">鎂 (Magnesium_mg)</option>
                                <option value="manganese">錳 (Manganese_mg)</option>
                                <option value="phosphorus">磷 (Phosphorus_mg)</option>
                                <option value="selenium">硒 (Selenium_mcg)</option>
                                <option value="zinc">鋅 (Zinc_mg)</option>
                            </optgroup>
                            <optgroup label="USRDA 百分比">
                                <option value="vitA_USRDA">維生素A USRDA</option>
                                <option value="vitB6_USRDA">維生素B6 USRDA</option>
                                <option value="vitB12_USRDA">維生素B12 USRDA</option>
                                <option value="vitC_USRDA">維生素C USRDA</option>
                                <option value="vitE_USRDA">維生素E USRDA</option>
                                <option value="folate_USRDA">葉酸 USRDA</option>
                                <option value="niacin_USRDA">菸鹼酸 USRDA</option>
                                <option value="riboflavin_USRDA">核黃素 USRDA</option>
                                <option value="thiamin_USRDA">硫胺素 USRDA</option>
                                <option value="calcium_USRDA">鈣 USRDA</option>
                                <option value="copper_USRDA">銅 USRDA</option>
                                <option value="magnesium_USRDA">鎂 USRDA</option>
                                <option value="phosphorus_USRDA">磷 USRDA</option>
                                <option value="selenium_USRDA">硒 USRDA</option>
                                <option value="zinc_USRDA">鋅 USRDA</option>
                            </optgroup>
                        </select>
                        <button id="apply-sort" class="sort-btn">重新排序</button>
                    </div>

                    <div class="chart-container">
                        <svg id="donut-chart"></svg>
                        <div class="center-info">
                            <div class="center-title">營養探索</div>
                            <div class="center-subtitle">拖拽食物到右側餐盤</div>
                        </div>
                        <div class="tooltip"></div>
                    </div>

                    <!-- 比較面板 -->
                    <div class="comparison-panel">
                        <div class="comparison-header">
                            <h3>營養成分比較</h3>
                            <div class="nutrition-mode-selector">
                                <label>顯示模式：</label>
                                <button class="mode-btn active" data-mode="all">全部營養</button>
                                <button class="mode-btn" data-mode="macro">五大營養</button>
                                <button class="mode-btn" data-mode="micro">維生素礦物質</button>
                            </div>
                            <button id="clear-comparison" class="clear-btn">清除全部</button>
                        </div>
                        <div class="comparison-hint">
                            點擊左側食物圓點或拖拽至此處進行比較
                        </div>
                        <div id="comparison-items" class="comparison-items"></div>
                    </div>
                </div>

                <div class="plate-section">
                    <div class="plate-title">智能營養餐盤</div>

                    <!-- 餐別選擇器 -->
                    <div class="meal-selector">
                        <label for="mealType">選擇餐別:</label>
                        <select id="mealType" onchange="updateMealRatios()">
                            <option value="breakfast">早餐</option>
                            <option value="lunch">午餐</option>
                            <option value="dinner">晚餐</option>
                        </select>
                    </div>

                    <!-- 餐別比例顯示 -->
                    <div class="meal-ratios" id="meal-ratios">
                        <h4>早餐建議比例</h4>
                        <div class="ratio-item"><span>全穀類:</span><span>30%</span></div>
                        <div class="ratio-item"><span>蛋豆魚肉類:</span><span>20%</span></div>
                        <div class="ratio-item"><span>蔬菜水果:</span><span>30%</span></div>
                        <div class="ratio-item"><span>其他:</span><span>20%</span></div>
                    </div>

                    <!-- 餐盤 -->
                    <div class="plate-container">
                        <div class="plate" id="plate"></div>
                        <!-- 營養素圓圈將由 JavaScript 動態生成 -->
                    </div>

                    <!-- TDEE 計算表單 -->
                    <div class="tdee-form">
                        <label for="height">身高 (cm):</label>
                        <input type="number" id="height" placeholder="170" />

                        <label for="weight">體重 (kg):</label>
                        <input type="number" id="weight" placeholder="70" />

                        <label for="age">年齡:</label>
                        <input type="number" id="age" placeholder="30" />

                        <label for="gender">性別:</label>
                        <select id="gender">
                            <option value="male">男性</option>
                            <option value="female">女性</option>
                        </select>

                        <label for="activity">活動水平:</label>
                        <select id="activity">
                            <option value="1.2">久坐</option>
                            <option value="1.375">輕度活動</option>
                            <option value="1.55">中度活動</option>
                            <option value="1.725">重度活動</option>
                            <option value="1.9">極重度活動</option>
                        </select>

                        <button onclick="calculateTDEE()">計算 TDEE</button>
                        <div class="tdee-display" id="tdee-display">TDEE: ? kcal</div>
                        <div class="recommend-display" id="recommend-display">
                            <div>蛋白質: ? g</div>
                            <div>脂肪: ? g</div>
                            <div>碳水化合物: ? g</div>
                        </div>
                    </div>

                    <!-- 營養素狀態 -->
                    <div class="nutrient-status">
                        <h4>營養素攝取狀態</h4>
                        <div id="nutrient-list"></div>
                    </div>

                    <!-- 當前攝取量顯示 -->
                    <div class="stats" style="grid-template-columns: 1fr;">
                        <div class="stat-card">
                            <div class="stat-number" id="current-energy">0</div>
                            <div class="stat-label">當前熱量 (kcal)</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="legend" id="legend"></div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-foods">0</div>
                    <div class="stat-label">總食物數量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="diet-groups">0</div>
                    <div class="stat-label">膳食群組數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="food-groups">0</div>
                    <div class="stat-label">食物群組數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avg-energy">0</div>
                    <div class="stat-label">平均熱量 (kcal)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let currentTDEE = Infinity;
        let currentStats = {
            Energy_kcal: 0, Protein_g: 0, Fat_g: 0, Carb_g: 0, Sugar_g: 0, Fiber_g: 0,
            VitA_mcg: 0, VitB6_mg: 0, VitB12_mcg: 0, VitC_mg: 0, VitE_mg: 0,
            Folate_mcg: 0, Niacin_mg: 0, Riboflavin_mg: 0, Thiamin_mg: 0,
            Calcium_mg: 0, Copper_mcg: 0, Iron_mg: 0, Magnesium_mg: 0,
            Manganese_mg: 0, Phosphorus_mg: 0, Selenium_mcg: 0, Zinc_mg: 0
        };
        let recommended = {};
        let inPlateItems = new Map();
        let allFoodsData = [];
        let currentGender = 'male';
        let currentAge = 30;
        let currentSortField = 'energy';
        let comparisonFoods = [];
        let globalProcessedData = [];
        let globalDietGroupColors = null;
        let nutritionDisplayMode = 'all';

        // 餐別比例設定
        const mealRatios = {
            breakfast: {
                name: '早餐',
                ratios: { grains: 30, protein: 20, vegetables: 30, others: 20 }
            },
            lunch: {
                name: '午餐',
                ratios: { grains: 40, protein: 30, vegetables: 25, others: 5 }
            },
            dinner: {
                name: '晚餐',
                ratios: { grains: 20, protein: 40, vegetables: 40, others: 0 }
            }
        };

        // 營養素建議攝取量 (RDA)
        const nutrientRDA = {
            Protein_g: { male: 56, female: 46 },
            Fat_g: null,
            Carb_g: null,
            Sugar_g: null,
            Fiber_g: {
                male: { '19-50': 38, '51+': 30 },
                female: { '19-50': 25, '51+': 21 }
            },
            VitA_mcg: { male: 900, female: 700 },
            VitB6_mg: { min: 1.3, max: 1.7 },
            VitB12_mcg: 2.4,
            VitC_mg: { male: 90, female: 75 },
            VitE_mg: 15,
            Folate_mcg: 400,
            Niacin_mg: { male: 16, female: 14 },
            Riboflavin_mg: { male: 1.3, female: 1.1 },
            Thiamin_mg: { male: 1.2, female: 1.1 },
            Calcium_mg: { min: 1000, max: 1200 },
            Copper_mcg: 900,
            Iron_mg: { male: 8, female: 18 },
            Magnesium_mg: { male: 420, female: 310 },
            Manganese_mg: { male: 2.3, female: 1.8 },
            Phosphorus_mg: 700,
            Selenium_mcg: 55,
            Zinc_mg: { male: 11, female: 8 }
        };

        // 餐盤中心位置
        const plateCenter = { x: 175, y: 175 };
        const plateRadius = 100;

        // 主要營養素圓圈位置
        const nutrientOffsets = {
            Energy_kcal: { x: 0, y: -140 },
            Protein_g: { x: 121, y: -70 },
            Fat_g: { x: 121, y: 70 },
            Carb_g: { x: 0, y: 140 },
            Sugar_g: { x: -121, y: 70 },
            Fiber_g: { x: -121, y: -70 }
        };

        // 營養素圓圈大小比例
        const nutrientScales = {
            Energy_kcal: d3.scaleSqrt().domain([0, 3000]).range([20, 35]).clamp(true),
            Protein_g: d3.scaleSqrt().domain([0, 200]).range([20, 35]).clamp(true),
            Fat_g: d3.scaleSqrt().domain([0, 150]).range([20, 35]).clamp(true),
            Carb_g: d3.scaleSqrt().domain([0, 400]).range([20, 35]).clamp(true),
            Sugar_g: d3.scaleSqrt().domain([0, 200]).range([20, 35]).clamp(true),
            Fiber_g: d3.scaleSqrt().domain([0, 100]).range([20, 35]).clamp(true)
        };

        // 更新餐別比例顯示
        function updateMealRatios() {
            const mealType = document.getElementById('mealType').value;
            const meal = mealRatios[mealType];
            const ratiosDiv = document.getElementById('meal-ratios');

            ratiosDiv.innerHTML = `
                <h4>${meal.name}建議比例</h4>
                <div class="ratio-item"><span>全穀類:</span><span>${meal.ratios.grains}%</span></div>
                <div class="ratio-item"><span>蛋豆魚肉類:</span><span>${meal.ratios.protein}%</span></div>
                <div class="ratio-item"><span>蔬菜水果:</span><span>${meal.ratios.vegetables}%</span></div>
                <div class="ratio-item"><span>其他:</span><span>${meal.ratios.others}%</span></div>
            `;
        }

        // 獲取營養素建議值
        function getNutrientRecommendation(nutrient) {
            const rda = nutrientRDA[nutrient];
            if (!rda) return null;

            if (typeof rda === 'number') return rda;

            if (rda.male && rda.female) {
                return rda[currentGender];
            }

            if (rda.min && rda.max) {
                return rda.min;
            }

            return rda;
        }

        // 計算纖維建議攝取量
        function getFiberRecommendation() {
            const fiberRDA = nutrientRDA.Fiber_g[currentGender];
            if (currentAge >= 51) {
                return fiberRDA['51+'];
            } else {
                return fiberRDA['19-50'];
            }
        }

        // TDEE 計算函數
        function calculateTDEE() {
            const h = +document.getElementById("height").value;
            const w = +document.getElementById("weight").value;
            const a = +document.getElementById("age").value;
            const g = document.getElementById("gender").value;
            const act = +document.getElementById("activity").value;

            if (!h || !w || !a || !act) {
                alert("請輸入完整資訊");
                return;
            }

            currentAge = a;
            currentGender = g;

            const bmr = g === "male"
                ? 10 * w + 6.25 * h - 5 * a + 5
                : 10 * w + 6.25 * h - 5 * a - 161;

            currentTDEE = bmr * act;

            document.getElementById("tdee-display").innerText = `TDEE: ${Math.round(currentTDEE)} kcal`;

            // 建議營養素攝取量計算
            recommended = {
                Energy_kcal: currentTDEE,
                Protein_g: getNutrientRecommendation('Protein_g'),
                Fat_g: (0.25 * currentTDEE) / 9,
                Carb_g: (0.5 * currentTDEE) / 4,
                Sugar_g: (0.1 * currentTDEE) / 4,
                Fiber_g: getFiberRecommendation(),
                VitA_mcg: getNutrientRecommendation('VitA_mcg'),
                VitB6_mg: getNutrientRecommendation('VitB6_mg'),
                VitB12_mcg: getNutrientRecommendation('VitB12_mcg'),
                VitC_mg: getNutrientRecommendation('VitC_mg'),
                VitE_mg: getNutrientRecommendation('VitE_mg'),
                Folate_mcg: getNutrientRecommendation('Folate_mcg'),
                Niacin_mg: getNutrientRecommendation('Niacin_mg'),
                Riboflavin_mg: getNutrientRecommendation('Riboflavin_mg'),
                Thiamin_mg: getNutrientRecommendation('Thiamin_mg'),
                Calcium_mg: getNutrientRecommendation('Calcium_mg'),
                Copper_mcg: getNutrientRecommendation('Copper_mcg'),
                Iron_mg: getNutrientRecommendation('Iron_mg'),
                Magnesium_mg: getNutrientRecommendation('Magnesium_mg'),
                Manganese_mg: getNutrientRecommendation('Manganese_mg'),
                Phosphorus_mg: getNutrientRecommendation('Phosphorus_mg'),
                Selenium_mcg: getNutrientRecommendation('Selenium_mcg'),
                Zinc_mg: getNutrientRecommendation('Zinc_mg')
            };

            updateNutrientsDisplay();
            updateNutrientStatus();
            document.getElementById("recommend-display").innerHTML = `
                <div>蛋白質: ${Math.round(recommended.Protein_g)} g</div>
                <div>脂肪: ${Math.round(recommended.Fat_g)} g</div>
                <div>碳水化合物: ${Math.round(recommended.Carb_g)} g</div>
                <div>纖維: ${Math.round(recommended.Fiber_g)} g</div>
            `;

            updateFoodAvailability();
        }

        // 建立營養素圓圈
        function createNutrientCircles() {
            const plateContainer = document.querySelector('.plate-container');

            Object.keys(nutrientOffsets).forEach(nutrient => {
                const offset = nutrientOffsets[nutrient];

                const circle = document.createElement('div');
                circle.className = 'nutrient-circle';
                circle.id = `nutrient-${nutrient}`;
                circle.style.left = `${plateCenter.x + offset.x - 25}px`;
                circle.style.top = `${plateCenter.y + offset.y - 25}px`;
                circle.style.width = '50px';
                circle.style.height = '50px';

                const label = nutrient.replace('_', ' ');
                circle.innerHTML = `<div>${label}<br/>0</div>`;

                plateContainer.appendChild(circle);
            });
        }

        // 更新營養素圓圈顯示
        function updateNutrientsDisplay() {
            Object.keys(nutrientOffsets).forEach(nutrient => {
                const circle = document.getElementById(`nutrient-${nutrient}`);
                const value = currentStats[nutrient];
                const recommendedValue = recommended[nutrient];

                // 更新大小
                const size = nutrientScales[nutrient](value);
                circle.style.width = `${size * 2}px`;
                circle.style.height = `${size * 2}px`;

                // 重新計算位置
                const offset = nutrientOffsets[nutrient];
                circle.style.left = `${plateCenter.x + offset.x - size}px`;
                circle.style.top = `${plateCenter.y + offset.y - size}px`;

                // 更新顏色狀態
                circle.classList.remove('complete', 'over-limit', 'insufficient', 'started');

                if (nutrient === 'Energy_kcal') {
                    if (value > currentTDEE) {
                        circle.classList.add('over-limit');
                    } else if (value >= currentTDEE * 0.8) {
                        circle.classList.add('complete');
                    } else if (value > 0) {
                        circle.classList.add('started');
                    }
                } else if (recommendedValue) {
                    if (value > recommendedValue) {
                        if (nutrient === 'Sugar_g') {
                            circle.classList.add('over-limit');
                        } else {
                            circle.classList.add('over-limit');
                        }
                    } else if (value >= recommendedValue) {
                        circle.classList.add('complete');
                    } else if (value > 0) {
                        circle.classList.add('started');
                    }
                }
                // 更新文字
                const label = nutrient.replace('_', '<br/>');
                const displayValue = value < 1 ? value.toFixed(1) : Math.round(value);
                circle.innerHTML = `<div>${label}<br/>${displayValue}</div>`;
            });

            document.getElementById('current-energy').textContent = Math.round(currentStats.Energy_kcal);
        }

        // 更新營養素狀態列表
        function updateNutrientStatus() {
            const nutrientList = document.getElementById('nutrient-list');
            let html = '';

            const mainNutrients = ['Protein_g', 'Fat_g', 'Carb_g', 'Sugar_g', 'Fiber_g'];
            const vitamins = ['VitA_mcg', 'VitB6_mg', 'VitB12_mcg', 'VitC_mg', 'VitE_mg', 'Folate_mcg', 'Niacin_mg', 'Riboflavin_mg', 'Thiamin_mg'];
            const minerals = ['Calcium_mg', 'Copper_mcg', 'Iron_mg', 'Magnesium_mg', 'Manganese_mg', 'Phosphorus_mg', 'Selenium_mcg', 'Zinc_mg'];

            [...mainNutrients, ...vitamins, ...minerals].forEach(nutrient => {
                const current = currentStats[nutrient];
                const target = recommended[nutrient];

                if (target) {
                    const percentage = (current / target) * 100;
                    let status = '';
                    let statusClass = '';

                    if (nutrient === 'Sugar_g' && current > target) {
                        status = '超標';
                        statusClass = 'over-limit';
                    } else if (percentage >= 100) {
                        status = '達標';
                        statusClass = 'complete';
                    } else if (percentage >= 50) {
                        status = `${Math.round(percentage)}%`;
                        statusClass = '';
                    } else {
                        status = `不足 (${Math.round(percentage)}%)`;
                        statusClass = 'insufficient';
                    }

                    const displayValue = current < 1 ? current.toFixed(2) : current.toFixed(1);
                    const displayTarget = target < 1 ? target.toFixed(2) : target.toFixed(1);
                    const unit = nutrient.includes('mcg') ? 'μg' : (nutrient.includes('mg') ? 'mg' : 'g');

                    html += `
                        <div class="nutrient-item">
                            <span>${nutrient.replace('_', ' ').replace('mcg', '').replace('mg', '').replace('g', '')}:</span>
                            <span class="nutrient-value ${statusClass}">${displayValue}/${displayTarget}${unit} (${status})</span>
                        </div>
                    `;
                }
            });

            nutrientList.innerHTML = html;
        }

        // 更新食物可用性
        function updateFoodAvailability() {
            d3.selectAll('.individual-food').each(function (d) {
                const circle = d3.select(this);

                // 檢查是否已在餐盤中
                if (d.inPlate) {
                    return; // 已在餐盤中的不處理
                }

                let shouldDisable = false;

                // 檢查 TDEE 限制
                if (currentTDEE !== Infinity) {
                    const wouldExceedTDEE = (currentStats.Energy_kcal + d.energy) > currentTDEE;
                    if (wouldExceedTDEE) {
                        shouldDisable = true;
                    }
                }

                // 檢查營養素是否會過量
                if (recommended.Sugar_g && (currentStats.Sugar_g + d.sugar) > recommended.Sugar_g * 1.2) {
                    shouldDisable = true;
                }
                if (recommended.Protein_g && (currentStats.Protein_g + d.protein) > recommended.Protein_g * 2) {
                    shouldDisable = true;
                }
                if (recommended.Fat_g && (currentStats.Fat_g + d.fat) > recommended.Fat_g * 1.5) {
                    shouldDisable = true;
                }

                // 設定樣式
                if (shouldDisable) {
                    circle.classed('disabled', true)
                        .style('opacity', 0.3)
                        .style('pointer-events', 'none')
                        .style('cursor', 'not-allowed');
                } else {
                    circle.classed('disabled', false)
                        .style('opacity', 0.9)
                        .style('pointer-events', 'all')
                        .style('cursor', 'pointer');
                }
            });
        }

        // 在餐盤中顯示食物
        function addFoodToPlate(food) {
            const plate = document.getElementById('plate');
            const foodItem = document.createElement('div');
            foodItem.className = 'plate-food-item';
            foodItem.id = `plate-food-${food.id}`;

            // 隨機位置在餐盤內
            const angle = Math.random() * 2 * Math.PI;
            const radius = Math.random() * (plateRadius - 20) + 10;
            const x = Math.cos(angle) * radius + plateRadius;
            const y = Math.sin(angle) * radius + plateRadius;

            foodItem.style.left = `${x - 6}px`;
            foodItem.style.top = `${y - 6}px`;
            foodItem.style.backgroundColor = food.dietGroupColor;
            foodItem.title = food.description;

            // 拖拽移除功能
            let isDragging = false;
            let startX, startY;

            foodItem.onmousedown = (e) => {
                isDragging = false;
                startX = e.clientX;
                startY = e.clientY;

                const onMouseMove = (e) => {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;

                    if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                        isDragging = true;
                    }

                    if (isDragging) {
                        foodItem.style.left = `${parseInt(foodItem.style.left) + dx}px`;
                        foodItem.style.top = `${parseInt(foodItem.style.top) + dy}px`;
                        startX = e.clientX;
                        startY = e.clientY;
                    }
                };

                const onMouseUp = (e) => {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);

                    if (isDragging) {
                        // 檢查是否拖出餐盤
                        const rect = foodItem.getBoundingClientRect();
                        const plateRect = document.querySelector('.plate').getBoundingClientRect();

                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        const isOutside = centerX < plateRect.left ||
                            centerX > plateRect.right ||
                            centerY < plateRect.top ||
                            centerY > plateRect.bottom;

                        if (isOutside) {
                            removeFoodFromPlate(food);
                        }
                    } else {
                        // 點擊移除
                        removeFoodFromPlate(food);
                    }
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };

            plate.appendChild(foodItem);
        }

        // 從餐盤移除食物
        function removeFoodFromPlate(food) {
            const foodItem = document.getElementById(`plate-food-${food.id}`);
            if (foodItem) {
                foodItem.remove();
            }

            // 更新統計
            food.inPlate = false;
            inPlateItems.delete(food.id);

            // 扣除營養素
            Object.keys(currentStats).forEach(nutrient => {
                const nutrientKey = nutrient.charAt(0).toLowerCase() + nutrient.slice(1);
                if (food[nutrientKey] !== undefined) {
                    currentStats[nutrient] -= food[nutrientKey];
                }
            });

            // 特殊處理欄位名稱不同的情況
            currentStats.Energy_kcal -= food.energy || 0;
            currentStats.Protein_g -= food.protein || 0;
            currentStats.Fat_g -= food.fat || 0;
            currentStats.Carb_g -= food.carb || 0;
            currentStats.Sugar_g -= food.sugar || 0;
            currentStats.Fiber_g -= food.fiber || 0;
            currentStats.VitC_mg -= food.vitC || 0;
            currentStats.Calcium_mg -= food.calcium || 0;
            currentStats.Iron_mg -= food.iron || 0;

            updateNutrientsDisplay();
            updateNutrientStatus();
            updateFoodAvailability();

            // 重新顯示圓形
            // 重新顯示並回到原位
            // 重新顯示並回原 donut 位置
            d3.selectAll('.individual-food')
                .each(function (d) {
                    if (d.id === food.id) {
                        d3.select(this)
                            .style('display', null) // 恢復顯示
                            .transition()
                            .duration(600)
                            .ease(d3.easeCubicOut)
                            .attr('cx', d.originalX)
                            .attr('cy', d.originalY);
                    }
                });


        }

        // 載入並處理資料
        async function loadData() {
            try {
                console.log('開始載入 CSV 資料...');

                const rawData = await d3.csv("test_labeled_new.csv");
                console.log('原始資料筆數:', rawData.length);

                const data = rawData
                    .map(d => ({
                        id: +d.ID,
                        foodGroup: d.FoodGroup?.trim(),
                        description: d.Descrip?.trim(),
                        energy: +d.Energy_kcal || 0,
                        protein: +d.Protein_g || 0,
                        fat: +d.Fat_g || 0,
                        carb: +d.Carb_g || 0,
                        sugar: +d.Sugar_g || 0,
                        fiber: +d.Fiber_g || 0,
                        vitA: +d.VitA_mcg || 0,
                        vitB6: +d.VitB6_mg || 0,
                        vitB12: +d.VitB12_mcg || 0,
                        vitC: +d.VitC_mg || 0,
                        vitE: +d.VitE_mg || 0,
                        folate: +d.Folate_mcg || 0,
                        niacin: +d.Niacin_mg || 0,
                        riboflavin: +d.Riboflavin_mg || 0,
                        thiamin: +d.Thiamin_mg || 0,
                        calcium: +d.Calcium_mg || 0,
                        copper: +d.Copper_mcg || 0,
                        iron: +d.Iron_mg || 0,
                        magnesium: +d.Magnesium_mg || 0,
                        manganese: +d.Manganese_mg || 0,
                        phosphorus: +d.Phosphorus_mg || 0,
                        selenium: +d.Selenium_mcg || 0,
                        zinc: +d.Zinc_mg || 0,
                        vitA_USRDA: +d.VitA_USRDA || 0,
                        vitB6_USRDA: +d.VitB6_USRDA || 0,
                        vitB12_USRDA: +d.VitB12_USRDA || 0,
                        vitC_USRDA: +d.VitC_USRDA || 0,
                        vitE_USRDA: +d.VitE_USRDA || 0,
                        folate_USRDA: +d.Folate_USRDA || 0,
                        niacin_USRDA: +d.Niacin_USRDA || 0,
                        riboflavin_USRDA: +d.Riboflavin_USRDA || 0,
                        thiamin_USRDA: +d.Thiamin_USRDA || 0,
                        calcium_USRDA: +d.Calcium_USRDA || 0,
                        copper_USRDA: +d.Copper_USRDA || 0,
                        magnesium_USRDA: +d.Magnesium_USRDA || 0,
                        phosphorus_USRDA: +d.Phosphorus_USRDA || 0,
                        selenium_USRDA: +d.Selenium_USRDA || 0,
                        zinc_USRDA: +d.Zinc_USRDA || 0,
                        dietGroup: d.Diet_Group?.trim()
                    }))
                    .filter(d => d.energy > 0 && d.dietGroup && d.foodGroup);

                console.log('處理後的資料筆數:', data.length);
                allFoodsData = data;
                return data;
            } catch (error) {
                console.error('CSV 載入錯誤:', error);
                throw error;
            }
        }

        // 主要繪圖函數
        async function createMultiLayerDonut() {
            try {
                const data = await loadData();

                if (data.length === 0) {
                    document.getElementById('loading').textContent = '載入的資料為空，請檢查檔案內容';
                    return;
                }

                // 建立營養素圓圈
                createNutrientCircles();

                // 隱藏載入畫面，顯示圖表
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chart-wrapper').style.display = 'block';

                // 處理資料結構
                const dietGroupData = d3.group(data, d => d.dietGroup);

                const processedData = [];
                const dietGroupColors = d3.scaleOrdinal([
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
                    '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD',
                    '#00D2D3', '#FF9F43', '#10AC84', '#EE5A24'
                ]);

                let totalFoods = 0;
                let totalEnergy = 0;

                Array.from(dietGroupData.entries()).forEach(([dietGroup, dietFoods]) => {
                    const foodGroupData = d3.group(dietFoods, d => d.foodGroup);

                    Array.from(foodGroupData.entries()).forEach(([foodGroup, foods]) => {
                        const sortedFoods = foods.sort((a, b) => b.energy - a.energy);

                        sortedFoods.forEach(food => {
                            processedData.push({
                                ...food,
                                dietGroup,
                                foodGroup,
                                dietGroupColor: dietGroupColors(dietGroup)
                            });
                            totalFoods++;
                            totalEnergy += food.energy;
                        });
                    });
                });

                // 更新統計資訊
                document.getElementById('total-foods').textContent = totalFoods;
                document.getElementById('diet-groups').textContent = new Set(data.map(d => d.dietGroup)).size;
                document.getElementById('food-groups').textContent = new Set(data.map(d => d.foodGroup)).size;
                document.getElementById('avg-energy').textContent = Math.round(totalEnergy / totalFoods);

                globalProcessedData = processedData;
                globalDietGroupColors = dietGroupColors;

                // 繪製圖表
                drawDonutChart(processedData, dietGroupColors);
                setupComparisonPanel();
                setupSortingControls();
                setupNutritionModeSelector();
                addClearButton(); // 加上這一行

            } catch (error) {
                console.error('繪圖過程發生錯誤:', error);
                document.getElementById('loading').textContent = `載入失敗: ${error.message}`;
            }
        }

        // 繪製甜甜圈圖表的函數
        function drawDonutChart(processedData, dietGroupColors) {
            console.log('開始繪製圖表，資料筆數:', processedData.length);

            // 清除之前的 SVG 內容
            d3.select('#donut-chart').selectAll("*").remove();

            // 設定 SVG 尺寸
            const width = 700;
            const height = 700;
            const radius = Math.min(width, height) / 2 - 40;

            const svg = d3.select('#donut-chart')
                .attr('width', width)
                .attr('height', height);

            const g = svg.append('g')
                .attr('transform', `translate(${width / 2}, ${height / 2})`);

            // 計算每個 diet group 的資料
            const dietGroupData = d3.group(processedData, d => d.dietGroup);

            const dietGroupPieData = Array.from(dietGroupData.entries()).map(([dietGroup, foods]) => ({
                dietGroup,
                value: d3.sum(foods, d => d.energy),
                totalEnergy: d3.sum(foods, d => d.energy),
                color: dietGroupColors(dietGroup)
            }));

            // 建立餅圖生成器
            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            const pieData = pie(dietGroupPieData);

            // 外圈：Diet Groups
            const outerRadius = radius;
            const innerRadius = radius * 0.95;

            const outerArc = d3.arc()
                .innerRadius(innerRadius)
                .outerRadius(outerRadius);

            g.selectAll('.outer-arc')
                .data(pieData)
                .join('path')
                .attr('class', 'outer-arc')
                .attr('d', outerArc)
                .attr('fill', d => d.data.color)
                .attr('stroke', '#fff')
                .attr('stroke-width', 1)
                .style('cursor', 'pointer')
                .on('mouseover', function (event, d) {
                    const foods = dietGroupData.get(d.data.dietGroup);
                    showTooltip(event, {
                        title: d.data.dietGroup,
                        content: `食物數量: ${foods.length}<br/>總熱量: ${d.data.totalEnergy.toFixed(1)} kcal`
                    });
                })
                .on('mouseout', hideTooltip);

            // Food Group 層
            const middleRadius = radius * 0.95;
            const middleInnerRadius = radius * 0.4;

            pieData.forEach((dietGroupSlice, index) => {
                const dietGroupName = dietGroupSlice.data.dietGroup;
                const safeDietGroupName = dietGroupName.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '-');
                const dietGroupFoods = processedData.filter(d => d.dietGroup === dietGroupName);

                const foodGroupData = d3.group(dietGroupFoods, d => d.foodGroup);

                const foodGroupPieData = Array.from(foodGroupData.entries()).map(([foodGroup, foods]) => ({
                    foodGroup,
                    value: d3.sum(foods, d => d.energy),
                    energy: d3.sum(foods, d => d.energy),
                    dietGroup: dietGroupName,
                    color: d3.color(dietGroupSlice.data.color).darker(0.2)
                }));

                if (foodGroupPieData.length === 0) return;

                const foodGroupPie = d3.pie()
                    .value(d => d.value)
                    .startAngle(dietGroupSlice.startAngle)
                    .endAngle(dietGroupSlice.endAngle)
                    .sort(null);

                const foodGroupSlices = foodGroupPie(foodGroupPieData);

                const middleArc = d3.arc()
                    .innerRadius(middleInnerRadius)
                    .outerRadius(middleRadius);

                // 繪製 Food Group 甜甜圈段
                g.selectAll(`.middle-arc-${safeDietGroupName}`)
                    .data(foodGroupSlices)
                    .join('path')
                    .attr('class', `middle-arc-${safeDietGroupName}`)
                    .attr('d', middleArc)
                    .attr('fill', d => d.data.color)
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 2)
                    .style('cursor', 'pointer')
                    .on('mouseover', function (event, d) {
                        const foods = foodGroupData.get(d.data.foodGroup);
                        showTooltip(event, {
                            title: d.data.foodGroup,
                            content: `膳食群組: ${d.data.dietGroup}<br/>食物數量: ${foods.length}<br/>總熱量: ${d.data.energy.toFixed(1)} kcal`
                        });
                    })
                    .on('mouseout', hideTooltip);

                // 繪製食物圓點
                foodGroupSlices.forEach((foodGroupSlice) => {
                    const foodGroupName = foodGroupSlice.data.foodGroup;
                    const individualFoods = dietGroupFoods.filter(d => d.foodGroup === foodGroupName);

                    const sortedFoods = individualFoods.sort((a, b) => {
                        const aValue = a[currentSortField] || 0;
                        const bValue = b[currentSortField] || 0;
                        return aValue - bValue;  // 改成從小排到大
                    });


                    const angleRange = foodGroupSlice.endAngle - foodGroupSlice.startAngle;
                    const ringWidth = middleRadius - middleInnerRadius;

                    const avgRadius = (middleRadius + middleInnerRadius) / 2;
                    const arcLength = angleRange * avgRadius;
                    const circleSpacing = 16;
                    const maxCirclesPerRow = Math.max(1, Math.floor(arcLength / circleSpacing));
                    const maxRows = Math.max(1, Math.floor(ringWidth / 16));
                    const maxCircles = maxCirclesPerRow * maxRows;

                    const foodsToShow = sortedFoods.slice(0, Math.min(maxCircles, sortedFoods.length));

                    if (foodsToShow.length === 0) return;

                    // 計算全域圓形大小比例
                    const allValues = globalProcessedData.map(food => food[currentSortField] || 0);
                    const globalMaxValue = Math.max(...allValues);
                    const globalMinValue = Math.min(...allValues);
                    const globalRange = globalMaxValue - globalMinValue || 1;

                    const circlesPerRow = Math.min(maxCirclesPerRow, foodsToShow.length);
                    const rows = Math.ceil(foodsToShow.length / circlesPerRow);

                    foodsToShow.forEach((food, foodIndex) => {
                        const row = Math.floor(foodIndex / circlesPerRow);
                        const col = foodIndex % circlesPerRow;

                        const angleStep = angleRange / (circlesPerRow + 1);
                        const angle = foodGroupSlice.startAngle + angleStep * (col + 1);

                        const radiusStep = ringWidth / (rows + 1);
                        const currentRadius = middleInnerRadius + radiusStep * (row + 1);

                        const x = Math.cos(angle - Math.PI / 2) * currentRadius;
                        const y = Math.sin(angle - Math.PI / 2) * currentRadius;

                        food.originalX = x;
                        food.originalY = y;

                        const sortValue = food[currentSortField] || 0;
                        const normalizedValue = (sortValue - globalMinValue) / globalRange;
                        const circleRadius = 2 + normalizedValue * 5;

                        g.append('circle')
                            .datum(food)  // ← 加上這一行！
                            .attr('class', 'individual-food draggable') // 確保有這個 class
                            .attr('cx', x)
                            .attr('cy', y)
                            .attr('r', circleRadius)
                            .attr('fill', d3.color(dietGroupColors(dietGroupName)).darker(1.2))
                            .attr('stroke', '#fff')
                            .attr('stroke-width', 0.5)
                            .attr('opacity', 0.9)
                            .style('cursor', 'pointer')
                            .attr('data-food-id', food.id)
                            .call(d3.drag()
                                .on('start', function (event) {
                                    d3.select(this).attr('opacity', 0.5);
                                })
                                .on('drag', function (event) {
                                    d3.select(this)
                                        .attr('cx', event.x)
                                        .attr('cy', event.y);
                                })

                                .on('end', function (event, d) {
                                    const circle = d3.select(this);
                                    circle.attr('opacity', 0.9);

                                    // 檢查是否拖拽到餐盤區域
                                    const plateRect = document.querySelector('.plate').getBoundingClientRect();

                                    // 計算相對於餐盤的位置
                                    const relativeX = event.sourceEvent.clientX - plateRect.left - plateRadius;
                                    const relativeY = event.sourceEvent.clientY - plateRect.top - plateRadius;
                                    const distanceToPlateCenter = Math.sqrt(relativeX * relativeX + relativeY * relativeY);

                                    const isInPlate = distanceToPlateCenter < plateRadius;

                                    // 檢查是否拖拽到比較面板
                                    const comparisonPanel = document.querySelector('.comparison-panel');
                                    const comparisonRect = comparisonPanel.getBoundingClientRect();

                                    const isInComparison = event.sourceEvent.clientX >= comparisonRect.left &&
                                        event.sourceEvent.clientX <= comparisonRect.right &&
                                        event.sourceEvent.clientY >= comparisonRect.top &&
                                        event.sourceEvent.clientY <= comparisonRect.bottom;

                                    if (isInPlate && !d.inPlate) {

                                        // 添加到餐盤
                                        d.inPlate = true;
                                        inPlateItems.set(d.id, d);

                                        // 更新營養統計
                                        currentStats.Energy_kcal += d.energy;
                                        currentStats.Protein_g += d.protein;
                                        currentStats.Fat_g += d.fat;
                                        currentStats.Carb_g += d.carb;
                                        currentStats.Sugar_g += d.sugar;
                                        currentStats.Fiber_g += d.fiber;
                                        currentStats.VitA_mcg += d.vitA || 0;
                                        currentStats.VitB6_mg += d.vitB6 || 0;
                                        currentStats.VitB12_mcg += d.vitB12 || 0;
                                        currentStats.VitC_mg += d.vitC || 0;
                                        currentStats.VitE_mg += d.vitE || 0;
                                        currentStats.Folate_mcg += d.folate || 0;
                                        currentStats.Niacin_mg += d.niacin || 0;
                                        currentStats.Riboflavin_mg += d.riboflavin || 0;
                                        currentStats.Thiamin_mg += d.thiamin || 0;
                                        currentStats.Calcium_mg += d.calcium || 0;
                                        currentStats.Copper_mcg += d.copper || 0;
                                        currentStats.Iron_mg += d.iron || 0;
                                        currentStats.Magnesium_mg += d.magnesium || 0;
                                        currentStats.Manganese_mg += d.manganese || 0;
                                        currentStats.Phosphorus_mg += d.phosphorus || 0;
                                        currentStats.Selenium_mcg += d.selenium || 0;
                                        currentStats.Zinc_mg += d.zinc || 0;

                                        updateNutrientsDisplay();
                                        updateNutrientStatus();
                                        updateFoodAvailability();

                                        // 在餐盤中顯示食物
                                        addFoodToPlate(d);

                                        // 隱藏圓形
                                        circle.style('display', 'none');

                                    } else if (isInComparison) {
                                        // 添加到比較面板
                                        addToComparison(d);
                                        circle.attr('cx', x).attr('cy', y);
                                    } else {
                                        // 回到原位置
                                        circle.attr('cx', x).attr('cy', y);
                                    }
                                })

                            )
                            .on('click', function (event) {
                                event.stopPropagation();
                                addToComparison(food);
                            })
                            .on('mouseover', function (event) {
                                d3.select(this)
                                    .transition()
                                    .duration(150)
                                    .attr('r', circleRadius * 1.2)
                                    .attr('opacity', 1);

                                showTooltip(event, {
                                    title: food.description.length > 35 ?
                                        food.description.substring(0, 35) + '...' :
                                        food.description,
                                    content: `膳食群組: ${food.dietGroup}<br/>食物群組: ${food.foodGroup}<br/>熱量: ${food.energy.toFixed(1)} kcal<br/>蛋白質: ${food.protein.toFixed(1)}g<br/>脂肪: ${food.fat.toFixed(1)}g<br/>碳水化合物: ${food.carb.toFixed(1)}g<br/>當前排序: ${getSortFieldDisplayName(currentSortField)} = ${sortValue.toFixed(2)}<br/><br/>點擊或拖拽到下方面板進行比較`
                                });
                            })
                            .on('mouseout', function () {
                                d3.select(this)
                                    .transition()
                                    .duration(150)
                                    .attr('r', circleRadius)
                                    .attr('opacity', 0.9);

                                hideTooltip();
                            });
                    });
                });
            });

            console.log('圖表繪製完成！');
            createLegend(Array.from(new Set(processedData.map(d => d.dietGroup))), dietGroupColors);
        }

        // 更新圓點位置和大小（帶動畫）
        function updateFoodCircles() {
            const allValues = globalProcessedData.map(food => food[currentSortField] || 0);
            const globalMaxValue = Math.max(...allValues);
            const globalMinValue = Math.min(...allValues);
            const globalRange = globalMaxValue - globalMinValue || 1;

            d3.selectAll('circle[data-food-id]').each(function () {
                const circle = d3.select(this);
                const foodId = +circle.attr('data-food-id');
                const food = globalProcessedData.find(f => f.id === foodId);

                if (food) {
                    const sortValue = food[currentSortField] || 0;
                    const normalizedValue = (sortValue - globalMinValue) / globalRange;
                    const newRadius = 2 + normalizedValue * 5;

                    circle.transition()
                        .duration(800)
                        .ease(d3.easeCubicOut)
                        .attr('r', newRadius);
                }
            });
        }

        // 設置排序功能
        function setupSortingControls() {
            const sortSelector = document.getElementById('sort-selector');
            const applyButton = document.getElementById('apply-sort');

            sortSelector.value = currentSortField;

            function applySorting() {
                const selectedField = sortSelector.value;
                currentSortField = selectedField;

                console.log('重新排序依據:', selectedField);

                // 重新繪製圖表（保持結構，只更新圓點）
                drawDonutChart(globalProcessedData, globalDietGroupColors);

                const centerSubtitle = document.querySelector('.center-subtitle');
                centerSubtitle.textContent = `依${getSortFieldDisplayName(selectedField)}排序`;
            }

            applyButton.addEventListener('click', applySorting);
        }

        function getSortFieldDisplayName(field) {
            const fieldNames = {
                'energy': '熱量', 'protein': '蛋白質', 'fat': '脂肪', 'carb': '碳水化合物',
                'sugar': '糖分', 'fiber': '纖維', 'vitA': '維生素A', 'vitB6': '維生素B6',
                'vitB12': '維生素B12', 'vitC': '維生素C', 'vitE': '維生素E',
                'folate': '葉酸', 'niacin': '菸鹼酸', 'riboflavin': '核黃素',
                'thiamin': '硫胺素', 'calcium': '鈣', 'copper': '銅', 'iron': '鐵',
                'magnesium': '鎂', 'manganese': '錳', 'phosphorus': '磷',
                'selenium': '硒', 'zinc': '鋅', 'vitA_USRDA': '維生素A USRDA',
                'vitB6_USRDA': '維生素B6 USRDA', 'vitB12_USRDA': '維生素B12 USRDA',
                'vitC_USRDA': '維生素C USRDA', 'vitE_USRDA': '維生素E USRDA',
                'folate_USRDA': '葉酸 USRDA', 'niacin_USRDA': '菸鹼酸 USRDA',
                'riboflavin_USRDA': '核黃素 USRDA', 'thiamin_USRDA': '硫胺素 USRDA',
                'calcium_USRDA': '鈣 USRDA', 'copper_USRDA': '銅 USRDA',
                'magnesium_USRDA': '鎂 USRDA', 'phosphorus_USRDA': '磷 USRDA',
                'selenium_USRDA': '硒 USRDA', 'zinc_USRDA': '鋅 USRDA'
            };
            return fieldNames[field] || field;
        }

        // 比較面板功能
        function addToComparison(food) {
            if (comparisonFoods.find(f => f.id === food.id)) return;
            comparisonFoods.push(food);
            updateComparisonPanel();
        }

        function removeFromComparison(foodId) {
            comparisonFoods = comparisonFoods.filter(f => f.id !== foodId);
            updateComparisonPanel();
        }

        function clearComparison() {
            comparisonFoods = [];
            updateComparisonPanel();
        }

        function updateComparisonPanel() {
            const container = document.getElementById('comparison-items');
            const hint = document.querySelector('.comparison-hint');

            if (comparisonFoods.length === 0) {
                hint.style.display = 'block';
                container.innerHTML = '';
                return;
            }

            hint.style.display = 'none';

            container.innerHTML = comparisonFoods.map(food => `
                <div class="comparison-item" data-food-id="${food.id}">
                    <div class="comparison-item-header">
                        <div class="comparison-item-title">${food.description.length > 50 ? food.description.substring(0, 50) + '...' : food.description}</div>
                        <button class="comparison-item-remove" onclick="removeFromComparison(${food.id})">×</button>
                    </div>
                    <div class="comparison-item-info">
                        ${food.dietGroup} | ${food.foodGroup}
                    </div>
                    <div class="nutrition-chart" id="nutrition-chart-${food.id}"></div>
                </div>
            `).join('');

            comparisonFoods.forEach(food => {
                drawNutritionChart(food);
            });
        }

        function drawNutritionChart(food) {
            const containerId = `nutrition-chart-${food.id}`;
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';

            const width = 380;
            // const height = 250;
            const height = 280;
            const centerX = width / 2;
            const centerY = height / 2 + 30;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // 根據顯示模式選擇要顯示的營養素 - 修正USRDA計算
            let nutrientsToShow = [];
            let macrosToShow = [];


            if (nutritionDisplayMode === 'all' || nutritionDisplayMode === 'micro') {
                nutrientsToShow = [
                    { name: 'VitA', value: (food.vitA_USRDA || 0) * 100, color: '#FF6B6B', unit: '%' },
                    { name: 'VitB6', value: (food.vitB6_USRDA || 0) * 100, color: '#4ECDC4', unit: '%' },
                    { name: 'VitB12', value: (food.vitB12_USRDA || 0) * 100, color: '#45B7D1', unit: '%' },
                    { name: 'VitC', value: (food.vitC_USRDA || 0) * 100, color: '#96CEB4', unit: '%' },
                    { name: 'VitE', value: (food.vitE_USRDA || 0) * 100, color: '#FECA57', unit: '%' },
                    { name: 'Folate', value: (food.folate_USRDA || 0) * 100, color: '#FF9FF3', unit: '%' },
                    { name: 'Ca', value: (food.calcium_USRDA || 0) * 100, color: '#54A0FF', unit: '%' },
                    { name: 'Fe', value: (food.iron_USRDA || 0) * 100, color: '#5F27CD', unit: '%' },
                    { name: 'Mg', value: (food.magnesium_USRDA || 0) * 100, color: '#00D2D3', unit: '%' },
                    { name: 'Zn', value: (food.zinc_USRDA || 0) * 100, color: '#FF9F43', unit: '%' }
                ];

                // 只在 'all' 模式下添加 Fiber，避免重複
                if (nutritionDisplayMode === 'all') {
                    nutrientsToShow = [
                        { name: 'VitA', value: (food.vitA_USRDA || 0) * 100, color: '#FF6B6B', unit: '%' },
                        { name: 'VitB6', value: (food.vitB6_USRDA || 0) * 100, color: '#4ECDC4', unit: '%' },
                        { name: 'VitB12', value: (food.vitB12_USRDA || 0) * 100, color: '#45B7D1', unit: '%' },
                        { name: 'VitC', value: (food.vitC_USRDA || 0) * 100, color: '#96CEB4', unit: '%' },
                        { name: 'VitE', value: (food.vitE_USRDA || 0) * 100, color: '#FECA57', unit: '%' },
                        { name: 'Folate', value: (food.folate_USRDA || 0) * 100, color: '#FF9FF3', unit: '%' },
                        { name: 'Ca', value: (food.calcium_USRDA || 0) * 100, color: '#54A0FF', unit: '%' },
                        { name: 'Fe', value: (food.iron_USRDA || 0) * 100, color: '#5F27CD', unit: '%' },
                        { name: 'Mg', value: (food.magnesium_USRDA || 0) * 100, color: '#00D2D3', unit: '%' },
                        { name: 'Zn', value: (food.zinc_USRDA || 0) * 100, color: '#FF9F43', unit: '%' }
                    ];
                    macrosToShow = [
                        { name: 'Protein', value: food.protein, color: '#8D6E63', unit: 'g' },
                        { name: 'Fat', value: food.fat, color: '#757575', unit: 'g' },
                        { name: 'Carb', value: food.carb, color: '#9E9E9E', unit: 'g' },
                        { name: 'Sugar', value: food.sugar, color: '#795548', unit: 'g' },
                        { name: 'Fiber', value: food.fiber, color: '#4CAF50', unit: 'g' }
                    ];
                }
            }

            if (nutritionDisplayMode === 'macro') {
                macrosToShow = [
                    { name: 'Protein', value: food.protein, color: '#8D6E63', unit: 'g' },
                    { name: 'Fat', value: food.fat, color: '#757575', unit: 'g' },
                    { name: 'Carb', value: food.carb, color: '#9E9E9E', unit: 'g' },
                    { name: 'Sugar', value: food.sugar, color: '#795548', unit: 'g' },
                    { name: 'Fiber', value: food.fiber, color: '#4CAF50', unit: 'g' }
                ];
            }


            // 頂部顯示ID和食物名稱
            svg.append('text')
                .attr('x', centerX)
                // .attr('y', 20)
                .attr('y', 25)
                .attr('text-anchor', 'middle')
                .attr('font-size', '14px')
                .attr('font-weight', 'bold')
                .attr('fill', '#333')
                .text(`ID ${food.id} - ${food.description.substring(0, 25)}${food.description.length > 25 ? '...' : ''}`);

            // 中央空心圓 - 改小一點
            const centralRadius = 15;
            svg.append('circle')
                .attr('cx', centerX)
                .attr('cy', centerY)
                .attr('r', centralRadius)
                .attr('fill', 'none')
                .attr('stroke', '#ddd')
                .attr('stroke-width', 2);

            // 能量bar - 垂直橘色bar，從中心圓向上延伸
            const energyBarHeight = Math.min(70, Math.max(15, food.energy * 0.08));
            const energyBarY = centerY - centralRadius - energyBarHeight;

            svg.append('rect')
                .attr('x', centerX - 6)
                .attr('y', energyBarY)
                .attr('width', 12)
                .attr('height', energyBarHeight)
                .attr('fill', '#FF9800')
                .attr('opacity', 0.9);

            // 能量bar的連接線
            svg.append('line')
                .attr('x1', centerX)
                .attr('y1', centerY - centralRadius)
                .attr('x2', centerX)
                .attr('y2', energyBarY + energyBarHeight)
                .attr('stroke', '#FF9800')
                .attr('stroke-width', 3)
                .attr('opacity', 0.8);

            svg.append('text')
                .attr('x', centerX)
                .attr('y', energyBarY - 8)
                .attr('text-anchor', 'middle')
                .attr('font-size', '10px')
                .attr('font-weight', 'bold')
                .attr('fill', '#FF9800')
                .text(`${food.energy.toFixed(0)} kcal`);

            // 繪製維生素礦物質線條（從中心圓向外延伸到圓周，避開五大營養素位置）
            if (nutrientsToShow.length > 0) {
                const outerRadius = 90;

                // 為維生素礦物質分配剩餘的角度空間，避開五大營養素和能量bar
                const occupiedAngles = [];

                // 能量bar佔據上方 -π/6 到 π/6
                occupiedAngles.push({ start: -Math.PI / 6, end: Math.PI / 6 });

                // 為維生素礦物質找到可用的角度空間
                const availableAngles = [];
                let currentAngle = 0;
                const totalAngle = 2 * Math.PI;
                const stepSize = totalAngle / (nutrientsToShow.length * 2); // 給更多空間

                for (let i = 0; i < nutrientsToShow.length; i++) {
                    let angle = (i / nutrientsToShow.length) * totalAngle;

                    // 檢查是否與佔用角度衝突，如果衝突則調整
                    let conflict = true;
                    let attempts = 0;
                    while (conflict && attempts < 20) {
                        conflict = false;
                        for (let occupied of occupiedAngles) {
                            if (angle >= occupied.start && angle <= occupied.end) {
                                angle += stepSize;
                                if (angle >= totalAngle) angle -= totalAngle;
                                conflict = true;
                                break;
                            }
                        }
                        attempts++;
                    }

                    availableAngles.push(angle);
                }
                const angleStep = (2 * Math.PI) / nutrientsToShow.length;

                nutrientsToShow.forEach((nutrient, i) => {
                    const angle = angleStep * i;

                    const isZeroValue = nutrient.value === 0;
                    const textColor = isZeroValue ? '#999' : nutrient.color;
                    const circleColor = isZeroValue ? '#ccc' : nutrient.color;

                    const startX = centerX + Math.cos(angle) * centralRadius;
                    const startY = centerY + Math.sin(angle) * centralRadius;

                    let lineLength = isZeroValue ? 2 :
                        nutrient.unit === '%'
                            ? Math.min(50, Math.max(8, (nutrient.value / 100) * 40 + 10))
                            : Math.min(50, Math.max(8, nutrient.value * 2 + 10));

                    const endX = centerX + Math.cos(angle) * (centralRadius + lineLength);
                    const endY = centerY + Math.sin(angle) * (centralRadius + lineLength);

                    svg.append('line')
                        .attr('x1', startX)
                        .attr('y1', startY)
                        .attr('x2', endX)
                        .attr('y2', endY)
                        .attr('stroke', circleColor)
                        .attr('stroke-width', 2.5)
                        .attr('opacity', isZeroValue ? 0.3 : 0.8);

                    const circleX = centerX + Math.cos(angle) * outerRadius;
                    const circleY = centerY + Math.sin(angle) * outerRadius;

                    svg.append('circle')
                        .attr('cx', circleX)
                        .attr('cy', circleY)
                        .attr('r', 4)
                        .attr('fill', circleColor)
                        .attr('opacity', isZeroValue ? 0.5 : 0.9);

                    // 偶數label外推一點避免重疊
                    const labelRadius = outerRadius + (i % 2 === 0 ? 35 : 45);
                    const labelX = centerX + Math.cos(angle) * labelRadius;
                    const labelY = centerY + Math.sin(angle) * labelRadius;

                    let textAnchor = 'middle';
                    if (Math.cos(angle) > 0.3) textAnchor = 'start';
                    else if (Math.cos(angle) < -0.3) textAnchor = 'end';

                    svg.append('text')
                        .attr('x', labelX)
                        .attr('y', labelY - 3)
                        .attr('text-anchor', textAnchor)
                        .attr('font-size', '9px')
                        .attr('font-weight', 'bold')
                        .attr('fill', textColor)
                        .text(nutrient.name);

                    svg.append('text')
                        .attr('x', labelX)
                        .attr('y', labelY + 8)
                        .attr('text-anchor', textAnchor)
                        .attr('font-size', '8px')
                        .attr('fill', textColor)
                        .text(`${nutrient.value.toFixed(1)}${nutrient.unit}`);
                });

            }

            // 繪製巨量營養素的線條（五大營養素均勻分佈從中心圓向外延伸）
            if (macrosToShow.length > 0) {
                // 為五大營養素分配特定角度，避開能量bar的位置（上方）
                const macroAngles = {
                    'Protein': Math.PI * 0.1,      // 右上
                    'Fat': Math.PI * 0.5,           // 右下
                    'Carb': Math.PI * 0.9,          // 左下
                    'Sugar': Math.PI * 1.3,         // 左上
                    'Fiber': Math.PI * 1.7         // 右側，遠離能量bar
                };

                macrosToShow.forEach((macro, i) => {
                    const angle = macroAngles[macro.name] || (Math.PI / 6 + i * (2 * Math.PI - Math.PI / 3) / macrosToShow.length);

                    // *** 先定義所有需要的變數 ***
                    const isZeroValue = macro.value === 0;
                    const macroColor = isZeroValue ? '#ccc' : macro.color;
                    const macroOpacity = isZeroValue ? 0.3 : 0.8;
                    const textColor = isZeroValue ? '#999' : macro.color;

                    // 計算線條長度（基於營養值，最小40，最大80）
                    let lineLength;
                    if (macro.value === 0) {
                        lineLength = 2; // 緊貼中心圓
                    } else {
                        const maxMacroValue = Math.max(...macrosToShow.map(m => m.value), 1);
                        const normalizedValue = macro.value / maxMacroValue;
                        lineLength = 40 + normalizedValue * 40; // 40-80px 範圍
                    }

                    const x1 = centerX + Math.cos(angle) * centralRadius;
                    const y1 = centerY + Math.sin(angle) * centralRadius;
                    const x2 = centerX + Math.cos(angle) * (centralRadius + lineLength);
                    const y2 = centerY + Math.sin(angle) * (centralRadius + lineLength);

                    // 線條
                    svg.append('line')
                        .attr('x1', x1)
                        .attr('y1', y1)
                        .attr('x2', x2)
                        .attr('y2', y2)
                        .attr('stroke', macroColor)
                        .attr('stroke-width', 4)
                        .attr('opacity', macroOpacity);

                    // 端點圓形
                    svg.append('circle')
                        .attr('cx', x2)
                        .attr('cy', y2)
                        .attr('r', 6)
                        .attr('fill', macroColor)
                        .attr('opacity', isZeroValue ? 0.5 : 0.9);

                    // 標籤位置（比端點再外一點）
                    const labelRadius = centralRadius + lineLength + 25;
                    const labelX = centerX + Math.cos(angle) * labelRadius;
                    const labelY = centerY + Math.sin(angle) * labelRadius;

                    // 根據角度調整文字對齊
                    let textAnchor = 'middle';
                    if (Math.cos(angle) > 0.3) textAnchor = 'start';
                    else if (Math.cos(angle) < -0.3) textAnchor = 'end';

                    svg.append('text')
                        .attr('x', labelX)
                        .attr('y', labelY - 5)
                        .attr('text-anchor', textAnchor)
                        .attr('font-size', '11px')
                        .attr('font-weight', 'bold')
                        .attr('fill', textColor)
                        .text(macro.name);

                    svg.append('text')
                        .attr('x', labelX)
                        .attr('y', labelY + 10)
                        .attr('text-anchor', textAnchor)
                        .attr('font-size', '10px')
                        .attr('fill', textColor)
                        .text(`${macro.value.toFixed(1)}${macro.unit}`);
                });
            }

            // 添加互動提示
            svg.append('rect')
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', width)
                .attr('height', height)
                .attr('fill', 'transparent')
                .style('cursor', 'pointer')
                .on('mouseover', function (event) {
                    const tooltipContent = `
                      ${food.description}<br/>
                      <strong>基本資訊：</strong><br/>
                      膳食群組: ${food.dietGroup}<br/>
                      食物群組: ${food.foodGroup}<br/>
                      <strong>巨量營養素：</strong><br/>
                      熱量: ${food.energy.toFixed(1)} kcal<br/>
                      蛋白質: ${food.protein.toFixed(1)} g<br/>
                      脂肪: ${food.fat.toFixed(1)} g<br/>
                      碳水化合物: ${food.carb.toFixed(1)} g<br/>
                      糖分: ${food.sugar.toFixed(1)} g<br/>
                      纖維: ${food.fiber.toFixed(1)} g<br/>
                      <strong>維生素 USRDA：</strong><br/>
                      維生素A: ${((food.vitA_USRDA || 0) * 100).toFixed(1)}%<br/>
                      維生素B6: ${((food.vitB6_USRDA || 0) * 100).toFixed(1)}%<br/>
                      維生素B12: ${((food.vitB12_USRDA || 0) * 100).toFixed(1)}%<br/>
                      維生素C: ${((food.vitC_USRDA || 0) * 100).toFixed(1)}%<br/>
                      維生素E: ${((food.vitE_USRDA || 0) * 100).toFixed(1)}%<br/>
                      葉酸: ${((food.folate_USRDA || 0) * 100).toFixed(1)}%<br/>
                      菸鹼酸: ${((food.niacin_USRDA || 0) * 100).toFixed(1)}%<br/>
                      核黃素: ${((food.riboflavin_USRDA || 0) * 100).toFixed(1)}%<br/>
                      硫胺素: ${((food.thiamin_USRDA || 0) * 100).toFixed(1)}%<br/>
                      <strong>礦物質 USRDA：</strong><br/>
                      鈣: ${((food.calcium_USRDA || 0) * 100).toFixed(1)}%<br/>
                      銅: ${((food.copper_USRDA || 0) * 100).toFixed(1)}%<br/>
                      鎂: ${((food.magnesium_USRDA || 0) * 100).toFixed(1)}%<br/>
                      磷: ${((food.phosphorus_USRDA || 0) * 100).toFixed(1)}%<br/>
                      硒: ${((food.selenium_USRDA || 0) * 100).toFixed(1)}%<br/>
                      鋅: ${((food.zinc_USRDA || 0) * 100).toFixed(1)}%
                  `;

                    showTooltip(event, {
                        title: `ID ${food.id}`,
                        content: tooltipContent
                    });
                })
                .on('mouseout', hideTooltip);
        }

        function setupComparisonPanel() {
            const comparisonPanel = document.querySelector('.comparison-panel');

            comparisonPanel.addEventListener('dragover', function (e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });

            comparisonPanel.addEventListener('dragleave', function (e) {
                e.preventDefault();
                this.classList.remove('drag-over');
            });

            comparisonPanel.addEventListener('drop', function (e) {
                e.preventDefault();
                this.classList.remove('drag-over');
            });

            document.getElementById('clear-comparison').addEventListener('click', clearComparison);
        }

        // 設置營養模式選擇器
        function setupNutritionModeSelector() {
            const modeButtons = document.querySelectorAll('.mode-btn');

            modeButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // 移除所有按鈕的 active 狀態
                    modeButtons.forEach(btn => btn.classList.remove('active'));
                    // 添加當前按鈕的 active 狀態
                    this.classList.add('active');

                    // 更新顯示模式
                    nutritionDisplayMode = this.getAttribute('data-mode');

                    // 重新繪製所有比較圖表
                    comparisonFoods.forEach(food => {
                        drawNutritionChart(food);
                    });
                });
            });
        }

        function showTooltip(event, data) {
            const tooltip = d3.select('.tooltip');
            tooltip.html(`<strong>${data.title}</strong><br/>${data.content}`)
                .style('opacity', 1)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            d3.select('.tooltip').style('opacity', 0);
        }

        function createLegend(dietGroups, colorScale) {
            const legend = d3.select('#legend');

            const legendItems = legend.selectAll('.legend-item')
                .data(dietGroups)
                .join('div')
                .attr('class', 'legend-item');

            legendItems.html(d => `
                <div class="legend-color" style="background-color: ${colorScale(d)}"></div>
                <span>${d}</span>
            `);
        }
        // 在餐盤標題旁邊添加清空按鈕
        function addClearButton() {
            const plateTitle = document.querySelector('.plate-title');
            plateTitle.innerHTML = `
        智能營養餐盤 
        <button onclick="clearPlate()" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">清空餐盤</button>
    `;
        }

        function clearPlate() {
            // 重置所有統計
            Object.keys(currentStats).forEach(key => {
                currentStats[key] = 0;
            });

            // 清空餐盤項目
            inPlateItems.forEach((food, id) => {
                // 移除餐盤中的視覺元素
                const foodItem = document.getElementById(`plate-food-${id}`);
                if (foodItem) {
                    foodItem.remove();
                }

                // 將 donut 圓點顯示出來並回到原始位置
                d3.selectAll('circle[data-food-id]')
                    .each(function (d) {
                        if (d.id === id) {
                            d3.select(this)
                                .style('display', null)
                                .transition()
                                .duration(600)
                                .ease(d3.easeCubicOut)
                                .attr('cx', d.originalX)
                                .attr('cy', d.originalY);
                        }
                    });

                food.inPlate = false;
            });

            inPlateItems.clear();

            // 更新顯示
            updateNutrientsDisplay();
            updateNutrientStatus();
            updateFoodAvailability();
        }


        // 啟動應用
        createMultiLayerDonut();
    </script>
</body>

</html>